name: Version Bump (Patch)

on:
  push:
    branches: [main]

permissions: {}

concurrency:
  group: version-bump
  cancel-in-progress: false

jobs:
  bump-patch:
    if: "!startsWith(github.event.head_commit.message, 'chore: bump version to')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          token: ${{ secrets.PAT }}

      - name: Bump patch version
        id: bump
        shell: python
        run: |
          import os
          import re

          with open("pyproject.toml") as f:
              content = f.read()

          match = re.search(r'^version = "(\d+)\.(\d+)\.(\d+)"', content, re.MULTILINE)
          if not match:
              raise ValueError("Could not find version in pyproject.toml")

          major, minor, patch = int(match.group(1)), int(match.group(2)), int(match.group(3))
          new_version = f"{major}.{minor}.{patch + 1}"

          new_content = re.sub(
              r'^version = "\d+\.\d+\.\d+"',
              f'version = "{new_version}"',
              content,
              count=1,
              flags=re.MULTILINE,
          )

          with open("pyproject.toml", "w") as f:
              f.write(new_content)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"new_version={new_version}\n")

      - name: Commit via GitHub API
        env:
          GH_TOKEN: ${{ secrets.PAT }}
          REPO: ${{ github.repository }}
          HEAD_SHA: ${{ github.sha }}
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          CONTENT=$(base64 < pyproject.toml)

          BLOB_SHA=$(gh api "repos/$REPO/git/blobs" \
            -f content="$CONTENT" \
            -f encoding=base64 \
            --jq '.sha')

          BASE_TREE=$(gh api "repos/$REPO/git/commits/$HEAD_SHA" --jq '.tree.sha')

          TREE_SHA=$(gh api "repos/$REPO/git/trees" \
            --input - <<EOF | jq -r '.sha'
          {
            "base_tree": "$BASE_TREE",
            "tree": [{"path": "pyproject.toml", "mode": "100644", "type": "blob", "sha": "$BLOB_SHA"}]
          }
          EOF
          )

          COMMIT_SHA=$(gh api "repos/$REPO/git/commits" \
            --input - <<EOF | jq -r '.sha'
          {
            "message": "chore: bump version to $NEW_VERSION",
            "tree": "$TREE_SHA",
            "parents": ["$HEAD_SHA"]
          }
          EOF
          )

          gh api "repos/$REPO/git/refs/heads/main" \
            -X PATCH \
            -f "sha=$COMMIT_SHA"
