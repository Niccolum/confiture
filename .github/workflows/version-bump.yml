name: Version Bump

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions: {}

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Bump version
        id: bump
        shell: python
        env:
          BUMP_TYPE: ${{ inputs.bump_type }}
        run: |
          import os
          import re

          bump_type = os.environ["BUMP_TYPE"]

          with open("pyproject.toml") as f:
              content = f.read()

          match = re.search(r'^version = "(\d+)\.(\d+)\.(\d+)"', content, re.MULTILINE)
          if not match:
              raise ValueError("Could not find version in pyproject.toml")

          major, minor, patch = int(match.group(1)), int(match.group(2)), int(match.group(3))

          if bump_type == "patch":
              new_version = f"{major}.{minor}.{patch + 1}"
          elif bump_type == "minor":
              new_version = f"{major}.{minor + 1}.0"
          elif bump_type == "major":
              new_version = f"{major + 1}.0.0"
          else:
              raise ValueError(f"Unknown bump type: {bump_type}")

          new_content = re.sub(
              r'^version = "\d+\.\d+\.\d+"',
              f'version = "{new_version}"',
              content,
              count=1,
              flags=re.MULTILINE,
          )

          with open("pyproject.toml", "w") as f:
              f.write(new_content)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"new_version={new_version}\n")

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT }}
          REPO: ${{ github.repository }}
          HEAD_SHA: ${{ github.sha }}
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          BRANCH="chore/bump-version-to-$NEW_VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git push origin --delete "$BRANCH" 2>/dev/null || true
          git checkout -b "$BRANCH"
          git add pyproject.toml
          git commit -m "chore: bump version to $NEW_VERSION"
          git push origin "$BRANCH"

          gh pr create \
            --title "chore: bump version to $NEW_VERSION" \
            --body "Automated ${{ inputs.bump_type }} version bump: â†’ **$NEW_VERSION**" \
            --base main \
            --head "$BRANCH"